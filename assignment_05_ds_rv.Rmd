---
title: 'Assignment #5'
author: "Richard Viebrock and David Segan"
date: "11/27/2019"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

### **Introduction**

A short (7 - 8 sentence) introduction that helps the reader understand the purpose/motivation of the research, and previews the content of the report. Add an image of the Pacific giant salamander, making sure to give appropriate credit to the author / creator) in the image figure caption.

### **Data and Methods**

A brief ‘Data and Methods’ section (5 - 6 sentences) summarizing the data and how it was analyzed. Briefly describe the variables being studied in this report. Include the types of statistical tests performed, significance level used, and software (with version) for analysis. Include a map of the area. You can use an already published map of the area, making sure to give appropriate credit to the author / creator) in the map figure caption.

```{r}

# ------------------------
# Attach Relevant Packages
# ------------------------

library(tidyverse)
library(janitor)
library(directlabels)
library(DT)
library(kableExtra)
library(ggbeeswarm)
library(car)
library(wesanderson)

```

### **Results**

#### Part A: Salamander Counts by Section

```{r}

# --------------------------------
# Read in data and filter for DITE 
# --------------------------------

mack_creek <- read_csv("mack_creek_vertebrates.csv") %>% 
  clean_names() %>% 
  filter(species == "DITE")

```

```{r, fig.width=6, fig.height=6, fig.cap = "**Figure 1**: *Insert caption here.*"}

# --------------------------------
# Results A: Create DF for salamander count graph
# --------------------------------

mack_creek_count <- mack_creek %>% 
  filter(section %in% c("CC", "OG")) %>% 
  mutate(section_name = if_else(section == "CC", "Clear Cut", "Old Growth")) %>% 
  select(year, section_name) %>% 
  group_by(year, section_name) %>% 
  summarize(count = n())

# -------------------------------------------
# Use ggplot to create salamander count graph
# -------------------------------------------

ggplot(data = mack_creek_count, aes(x = year, y = count, group = section_name))+
  geom_line(aes(color = section_name), size = 1, show.legend = FALSE)+
  geom_point(color = "gray30")+
  geom_dl(aes(label = section_name, color = section_name), method = list(dl.combine("last.points"), cex = 0.85))+
  scale_color_manual(values = wes_palette("Cavalcanti1"))+
  scale_x_continuous(expand = c(0, 0),
                   limits = c(1993, 2021),
                   breaks = seq(1993, 2018, by = 5))+
  scale_y_continuous(expand = c(0, 0),
                     limits = c(0, 400),
                     breaks = seq(0, 400, by = 100))+
  labs(x = "Year",
       y = "Count",
       title = "Salamander Counts by Section: 1993 - 2017")+
  theme_minimal()

```

##### Interesting Trends
- Interesting trend 1
- Interesting trend 2
- Interesting trend 3


#### Results B: 2017 Salamander Counts by Channel Classification

**Figure 2:** *Insert caption here*
```{r}

# ---------------------------------------------------------------------
# Results B: Create DF for table (channel classification & forest type)
# ---------------------------------------------------------------------

mack_c_table <- mack_creek %>% 
  filter(section %in% c("OG", "CC")) %>% 
  mutate(section_name = if_else(section == "CC", "Clear Cut", "Old Growth")) %>% 
  select(year, section_name, unittype) %>%
  filter(year == 2017,
         unittype %in% c("C", "P", "SC")) %>% 
  group_by(section_name, unittype) %>% 
  summarize(count = n()) %>% 
  pivot_wider(names_from = unittype, values_from = count) %>% 
  rename(Cascades = "C",
         Pool = "P",
         "Side Channel" = "SC",
         Section = "section_name")

mack_c_props <- mack_c_table %>% 
  adorn_percentages(denominator = "row") %>% 
  adorn_pct_formatting(digits = 1) %>% 
  adorn_ns(position = "front")

# ------------------------------------
# Create contingency table using kable
# ------------------------------------

kable(mack_c_props) %>% 
  kable_styling()

```


#### Results C: Analysis of Salamander Counts by Channel Classification
```{r}

# ----------------------------------------------------
# Results C: Use chi-squared to determine independence
# ----------------------------------------------------

chi_mack <- mack_c_table %>%
  ungroup() %>% 
  select(-Section)

chi_mack_test <- chisq.test(chi_mack)
```

Chi Squared test of independence: `r (chi_mack_test$statistic)`

Regarding the locations where salamanders were observed in Mack Creek in 2017, is there a significant effect of forest condition (old growth or clear cut) on where in the channel salamanders are found (channel classification)? Report your statistical findings in text, in the context of the actual counts / proportions you present in the table. 


#### Results D: Pacific Giant Salamander Weights by Section

```{r, fig.width=6, fig.height=6, fig.cap = "**Figure 1**: *Insert caption here.*"}

# ---------------------------------------------
# Results D: Create data frame to compare means
# ---------------------------------------------

mack_c_weights_graph <- mack_creek %>% 
  select("year", "section", "weight") %>% 
  filter(section %in% c("OG", "CC"),
         year == 2017)

mack_c_summary <- mack_c_weights_graph %>% 
  group_by(section) %>% 
  summarize(
    mean_weight = mean(weight, na.rm = TRUE),
    sd_weight = sd(weight, na.rm = TRUE))

# ---------------------------------------
# Use ggbeeswarm to visually compare means
# ---------------------------------------

ggplot()+
  geom_jitter(data = mack_c_weights_graph, 
                aes(x = section, y = weight, color = section),
                size = 1.5,
                alpha = 0.6,
                show.legend = FALSE) +
  scale_color_manual(values = wes_palette("Cavalcanti1"))+
  geom_point(data = mack_c_summary,
             aes(x = section, y = mean_weight),
             color = "black",
             size = 2.25) +
  geom_errorbar(data = mack_c_summary,
                aes(x = section,
                    ymin = mean_weight - sd_weight,
                    ymax = mean_weight + sd_weight),
                width = 0.1,
                size = 1.15,
                color = "black")+
  scale_x_discrete(labels = c("Clear Cut", "Old Growth"))+
  labs(x = "Section",
       y = "Weight",
       title = "2017 Means Comparison: Old Growth vs Clear Cut")+
  theme_minimal()

# Make sure that the beeswarm and the means are lined up appropriately. How do you make sure? Visual Check?
```

```{r}

# --------------------------------------------------
# Conduct a means comparison using a 2-sample t-test
# --------------------------------------------------

 mack_weights_cc <- mack_c_weights_graph %>% 
   filter(section == "CC") %>% 
   pull(weight)

 mack_weights_og <- mack_c_weights_graph %>% 
   filter(section == "OG") %>% 
   pull(weight)

 mack_means_comparison <- t.test(mack_weights_og, mack_weights_cc)

```

##### Means Comparison Analysis

There is not a significant difference: (t(`r round(mack_means_comparison$p.value, 2)`) = `r round(mack_means_comparison$p.value, 3)`

```{r}

# ---------------------------------------------------
# Results E: Create data frame to compare by unittype
# ---------------------------------------------------

 mack_pcs_weights <- mack_creek %>% 
  select("year", "unittype", "weight", "section") %>% 
   filter(unittype %in% c("C", "P", "SC"),
          year == 2017,
          section %in% c("CC", "OG")) %>% 
  mutate(unittype = ifelse(unittype == "C", "Cascades",
                           ifelse(unittype == "P", "Pool", "Side Channel")))
 
 mack_pcs_summary <- mack_pcs_weights %>% 
   group_by(unittype) %>% 
   summarize(
     mean_weight = mean(weight, na.rm = TRUE),
     sd_weight = sd(weight, na.rm = TRUE),
     sample_size = n(),
     se_weight = sd(weight, na.rm = TRUE) / sqrt(n()),
     var_weight = var(weight, na.rm = TRUE))

```

```{r}

# ------------------------------------
# Make a QQ plot to determine normalcy
# ------------------------------------

ggplot(data = mack_pcs_weights, aes(sample = weight))+
  geom_qq(aes(color = unittype), show.legend = FALSE)+
  scale_color_manual(values = wes_palette("Darjeeling1"))+
  facet_wrap(~unittype)+
  labs(x = "Theoretical",
       y = "Samples")

ggplot(data = mack_pcs_weights, aes(x = weight))+
  geom_histogram(aes(fill = unittype), 
                 color = "black", 
                 show.legend = FALSE)+
  scale_fill_manual(values = wes_palette("Darjeeling1"))+
  facet_wrap(~unittype)+
  labs(x = "Weight",
       y = "Count")

# ------------------------------------------------
# Conduct a Lavene's test to ensure equal variance
# ------------------------------------------------

leveneTest(weight ~ unittype, data = mack_pcs_weights)

# ----------------------------------------------------
# Conduct a chi-squared test to check for independence?
# ----------------------------------------------------

# chi_pcs_mack <- mack_pcs_weights %>%
# group_by(unittype) %>% 
#  summarize(weight = mean(weights))

```

```{r}

# -----------------------------------
# Make beeswarm plot to compare means
# -----------------------------------

ggplot()+
   geom_jitter(data = mack_pcs_weights,
                 aes(x = unittype, y = weight, color = unittype),
                 size = 1,
                 alpha = 0.6,
               show.legend = FALSE) +
   scale_color_manual(values = wes_palette("Darjeeling1"))+
   geom_point(data = mack_pcs_summary,
              aes(x = unittype, y = mean_weight),
              color = "black",
              size = 2)+
   geom_errorbar(data = mack_pcs_summary,
                 aes(x = unittype,
                     ymin = mean_weight - sd_weight,
                     ymax = mean_weight + sd_weight),
                 width = 0.1,
                 color = "black") +
   scale_x_discrete(labels = c("Cascade", "Pool", "Side Channel"))+
  labs(x = "Unit Type",
       y = "Weight (grams)",
       title = "Means Comparison by Channel Clasification")

 # Make sure that data is lined up correctly so that you don't have a mean in the wrong place. If the mack_pcs_weights is in the same order as mack_pcs_summary, everything works

```

```{r}

# ----------------------------------------
# Conduct a one-way ANOVA to compare means
# ----------------------------------------

mack_aov <- aov(weight ~ unittype, data = mack_pcs_weights)
summary(mack_aov)

# ----------------------------------------
# Conduct Tukey's HSD for post-hoc testing
# ----------------------------------------

TukeyHSD(mack_aov)

```